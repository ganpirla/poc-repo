---
- name: Audit user accounts on OCI Linux Compute instances
  hosts: all
  gather_facts: yes

  tasks:
    - name: Get list of all user accounts
      shell: cat /etc/passwd | cut -d ":" -f 1
      register: user_list
      changed_when: false

    - name: Delete user account details file if it exist
      file:
        path: /tmp/user-account-list-details.txt
        state: absent
      delegate_to: localhost

    - name: Create user account details  file if it doesn't exist
      file:
        path: /tmp/user-account-list-details.txt
        state: touch
      delegate_to: localhost
      when: not ansible_check_mode


    - name: Generate user account audit report
      shell: |
        for user in {{ user_list.stdout_lines | join(' ') }}; do
          echo "User account: $user"
          echo "Groups user is member of: $(groups $user)"
          echo "Last login: $(lastlog -u $user |tail -n 1 | cut -c 44-)"
          echo "Password expiry: $(chage -l $user | grep 'Password expires' | cut -d ':' -f 2)"
          echo "Last password change: $(chage -l $user | grep 'Last password change' | cut -d ':' -f 2)"                        
          echo ""
          echo ""
          
        done
      register: user_audit_report_output
      changed_when: false

    - name: Append debug output to file on control node
      lineinfile:
        line: |
          {{ inventory_hostname }} Audit report for user accounts on OCI Linux Compute instances:
          {{ user_audit_report_output.stdout }}
        path: /tmp/user-account-list-details.txt
        insertafter: EOF
      delegate_to: localhost

    - name: Send mail notification
      shell: |
        (echo "Subject : Need Validation - Nonprod OCI Compute Instance user accounts audit report"; cat /tmp/user-account-list-details.txt) |  /usr/sbin/sendmail -vf FINTRAN_CLOUD_DBA_INFRA@list.att.com gp085c@att.com
      args:
        executable: /bin/bash
      delegate_to: localhost
      run_once: true   
